<!DOCTYPE html>
<html lang="en">
<head>
	<title>Important Zites</title>
	<meta charset="utf-8">
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="keywords" content="zite,zites,important,krixano,list,category,search,filter">
	<base href="" target="_top" id="base">
	<script>base.href = document.location.href.replace("/media", "").replace("index.html", "").replace(/[&?]wrapper=False/, "").replace(/[&?]wrapper_nonce=[A-Za-z0-9]+/, "")</script>

	<link rel="stylesheet" href="css/bulma.css" />
	<link rel="stylesheet" href="css/main.css" />

	<script src="js/navToggle.js"></script>

	<style>
		#messages li {
			margin-bottom: 10px;
		}
		#current_user_messages li {
			margin-bottom: 10px;
		}
		#requestForm, #zite_num {
			visibility: hidden;
		}
		html, body, section {
			background: #f8f8f8 !important;
		}
	</style>
</head>
<body>
	<nav class="nav has-shadow">
		<div class="container">
			<div class="nav-left">
				<a href="./" class="nav-item" style="font-weight: bold;">Important Zites</a>
				<span class="nav-item"><code id="zite_num" class="tag is-light">0</code></span>
			</div>

			<!-- This "nav-toggle" hamburger menu is only visible on mobile -->
			<!-- You need JavaScript to toggle the "is-active" class on "nav-menu" -->
			<span id="nav-toggle" class="nav-toggle">
				<span></span>
				<span></span>
				<span></span>
			</span>

			<!-- This "nav-menu" is hidden on mobile -->
			<!-- Add the modifier "is-active" to display it on mobile -->
			<div id="nav-menu" class="nav-right nav-menu">
				<a href="./" class="nav-item">Home</a>
				<!--<a class="nav-item">Blog</a>-->
				<a class="nav-item is-active">Requests</a>
				<a href="about.html" class="nav-item">About</a>
				<span class="nav-item"><a href="#Select+user" id="select_user" class="button is-info" onclick='return page.selectUser()'>Select user</a></span>
			</div>
		</div>
	</nav>

	<section class="section">
		<div class="columns">
			<div class="column is-8 is-offset-2">
				<!--<h2 class="title is-2">Requests</h2>-->
				<p>
					To request a zite be added or removed (in the case a zite is abandoned, etc.), submit the link in the form below. Or you can send me a request by emailing me the link to the zite on ZeroMail via <a href="/Mail.ZeroNetwork.bit/?to=krixano">this link</a>.
					<br><em>Once a zite has been added/removed, the request will be removed.</em>
				</p>
				<div class="columns">
					<div class="column is-6">
						<form id="requestForm" onsubmit="return page.sendMessage()" class="modal">
							<div class="modal-background" onclick="toggleRequestForm();"></div>
							<div class="modal-card">
								<header class="modal-card-head">
									<p class="modal-card-title">Add Request</p>
									<a class="delete" onclick="toggleRequestForm(); return false;"></a>
								</header>
								<section class="modal-card-body">
									<div class="field">
										<p class="control">
											<input type="text" id="title" name="title" class="input" placeholder="Title" required>
										</p>
									</div>
									<div class="field">
										<p class="control">
											<input type="url" id="message" name="message" class="input" onkeypress="if (event.keyCode == 13) page.sendMessage()" placeholder="Link" required>
										</p>
									</div>
									<!--<div class="field">
										<p class="control">
											<input type="url" id="description" name="description" class="input" placeholder="Description" required>
										</p>
									</div>--> <!-- TODO -->
									<div class="field">
										<p class="control">
											<input type="text" id="removal_reason" name="removal_reason" class="input" onkeypress="if (event.keyCode == 13) page.sendMessage()" placeholder="Reason For Removal" style="display: none;">
										</p>
									</div>
									<div class="field">
										<p class="control">
											<label class="radio">
												<input type="radio" name="request_type" value="a" checked onclick="page.hideRemovalReasonTextbox()">
												Add
											</label>
											<label class="radio">
												<input type="radio" name="request_type" value="r" onclick="page.showRemovalReasonTextbox()">
												Remove
											</label>
											<!--<label class="radio">
												<input type="radio" name="request_type" value="u" onclick="page.hideRemovalReasonTextbox()">
												Update
											</label>--> <!-- TODO -->
										</p>
									</div>
								</section>
								<footer class="modal-card-foot">
									<button class="button is-success">Submit</button>
									<a class="button is-link" onclick="toggleRequestForm(); return false;">Cancel</a>
								</footer>
							</div>
						</form>
					</div>
				</div>
				<div style="margin-bottom: 15px;"><h3 class="title is-4" style="font-style: bold; display: inline;">Your Requests</h3>
				<small><em><a id="addRequestLink" style="margin-left: 10px; font-style: bold; display: none;" onclick="toggleRequestForm(); return false;">Add Request</a></em></small></div>
				<ul id="current_user_messages">
				</ul>
				<h3 class="title is-4" style="margin-bottom: 15px; margin-top: 20px;">Others' Requests</h3>
				<ul id="messages">
				</ul>
			</div>
		</div>
	</section>

	<footer class="footer">
		<div class="container">
			<span style="text-align: center">
				<small>NOTE: This zite is still a work-in-progress.</small><br>
				<small>Zite created on April 12th, 2017 by <a href="/Me.ZeroNetwork.bit/?Profile/12h51ug6CcntU2aiBjhP8Ns2e5VypbWWtv/12gAes6NzDS9E2q6Q1UXrpUdbPS6nvuBPu/krixano@zeroid.bit">krixano@zeroid.bit</a> (Christian Seibold)</small><br>
				<small><a href="https://github.com/krixano/ImportantZites">Github Link</a></small>
			</span>
		</div>
	</footer>

	<script type="text/javascript" src="js/ZeroFrame.js"></script>
	<script type="text/javascript" src="js/gsap/TweenLite.min.js"></script>
	<script type="text/javascript" src="js/gsap/plugins/CSSPlugin.min.js"></script>

	<script>
		class ZeroChat extends ZeroFrame {
			addMessage (username, message, title, request_type, removal_reason, isByCurrentUser) {
				var message_escaped = message.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&/g, "&amp;");  // Escape html tags in the message
				var message_url = message.replace(/http:\/\/127\.0\.0\.1:43110/, "").replace(/127\.0\.0\.1:43110/, "").replace(/http:\/\/localhost:43110/, "").replace(/localhost:43110/, "");
				
				if (!title) {
					title = message_escaped;
				}

				var request_type_text = "";
				if (request_type) {
					if (request_type == 'a') {
						request_type_text = "Add";
					} else if (request_type == 'r') {
						request_type_text = "Remove";
					}
				} else {
					request_type_text = "Add";
				}

				var removal_reason_text = "";
				if (removal_reason) {
					removal_reason_text = "<p>" + removal_reason + "</p>";
				}

				if (isByCurrentUser == true) {
					//this.currentUserMessages.innerHTML += "<li><h2 class='title is-5'>" + username + "</h2><em>" + request_type_text + " <a href='" + message_url + "'>" + message_escaped + "</a> " + removal_reason_text + "</em></li><hr>";
					this.currentUserMessages.innerHTML += "<li class='box'><h2 class='title is-5'>" + request_type_text + " <a href='" + message_url + "'>" + title + "</a> " + "<br><small><em>" + username + "</em></small></h2>" + removal_reason_text + "</li>";
				} else {
					//this.messages_container.innerHTML += "<li><b>" + username + ":</b> <em>" + request_type_text +" <a href='" + message_url + "'>" + message_escaped + "</a> " + removal_reason_text + "</em></li>";
					this.messages_container.innerHTML += "<li class='box'><h2 class='title is-5'>" + request_type_text + " <a href='" + message_url + "'>" + message_escaped + "</a> " + "<br><small><em>" + username + "</em></small></h2>" + removal_reason_text + "</li>";
				}
				//var html = "<li><b>" + username + ":</b> <em><a href='" + message + "'>" + message_escaped + "</a></em></li>";
				//$(html).hide().appendTo("#messages").fadeIn();
			}

			onOpenWebsocket () {
				this.messages_container = document.getElementById("messages");
				this.currentUserMessages = document.getElementById("current_user_messages");

				this.cmd("siteInfo", {}, (site_info) => {
					if (site_info.cert_user_id) {
						document.getElementById("select_user").innerText = site_info.cert_user_id;
						document.getElementById('addRequestLink').style.display = "";
					}
					this.site_info = site_info;
					this.loadMessages();
					this.loadZiteIndicator();
				});
			}

			selectUser () {
				this.cmd("certSelect", {accepted_domains: ["zeroid.bit", "kaffie.bit"]})
				return false
			}

			onRequest (cmd, message) {
				if (cmd == "setSiteInfo") {
					this.site_info = message.params  // Save site info data to allow access it later
					if (message.params.cert_user_id) {
						document.getElementById("select_user").innerHTML = message.params.cert_user_id
						document.getElementById('addRequestLink').style.display = "";
						this.loadMessages();
					} else if (!message.params.cert_user_id) {
						document.getElementById("select_user").innerHTML = "Select user"
						document.getElementById('addRequestLink').style.display = "none";
						this.loadMessages();
					} else if (message.params.event && message.params.event[0] == "file_done") {
						this.loadMessages();
						this.loadZiteIndicator();
					}
				}
			}

			sendMessage() {
				// No account selected -> Display error
				if (!this.site_info.cert_user_id) {
					this.cmd("wrapperNotification", ["info", "Please, select your account."]);
					this.selectUser();
					return false;
				}

				// This is the data file path
				var data_inner_path = "data/users/" + this.site_info.auth_address + "/data.json";
				var content_inner_path = "data/users/" + this.site_info.auth_address + "/content.json";

				// Load our current messages
				this.cmd("fileGet", {"inner_path": data_inner_path, "required": false}, (data) => {
					if (data)
						data = JSON.parse(data);
					else
						data = { "message": [] }

					// Get info for data
					var request_type = 'a';
					var querySelector = document.querySelector('input[name="request_type"]:checked');
					if (querySelector) {
						request_type = querySelector.value;
					}

					// Add the new message to data
					data.message.push({
						"body": document.getElementById("message").value,
						"title": document.getElementById('title').value,
						"request_type": request_type,
						"removal_reason": request_type == 'r' ? document.getElementById("removal_reason").value : "",
						"date_added": Date.now()
					});

					// Encode data array to utf8 json text
					var json_raw = unescape(encodeURIComponent(JSON.stringify(data, undefined, '\t')));

					// Write file to disk
					this.cmd("fileWrite", [data_inner_path, btoa(json_raw)], (res) => {
						if (res == "ok") {
							// Reset the message input
							document.getElementById("message").value = "";
							document.getElementById("removal_reason").value = "";
							// Sign the changed file in our user's directory
							this.cmd("siteSign", {"inner_path": content_inner_path}, (res) => {
								this.loadMessages(); // Reload Messages
								// publish to other users
								this.cmd("sitePublish", {"inner_path": content_inner_path, "sign": false});
							});
						} else {
							this.cmd("wrapperNotification", ["error", "File write error: #{res}"]);
						}

						toggleRequestForm();
					});
				});

				return false;
			}

			loadMessages() {
				//this.messages_container.style.display = "none";
				//this.currentUserMessages.style.display = "none";
				TweenLite.set(this.messages_container, {autoAlpha: 0});
				TweenLite.set(this.currentUserMessages, {autoAlpha: 0});

				this.cmd("dbQuery", ["SELECT * FROM message LEFT JOIN json USING (json_id) ORDER BY date_added DESC"], (messages) => {
					this.messages_container.innerHTML = ""; // Always star with empty messages
					this.currentUserMessages.innerHTML = "";

					for (var i = 0; i < messages.length; i++) {
						if (messages[i].cert_user_id == this.site_info.cert_user_id) {
							this.addMessage(messages[i].cert_user_id, messages[i].body, messages[i].title, messages[i].request_type, messages[i].removal_reason, true);
						} else {
							this.addMessage(messages[i].cert_user_id, messages[i].body, messages[i].title, messages[i].request_type, messages[i].removal_reason, false);
						}
					}
					if (!this.site_info.cert_user_id) {
						this.currentUserMessages.innerHTML = "<li id='default'><em>Please <a href='#Select+user' onclick='return page.selectUser()'>Select User</a> to see your requests.</em></li>";
					}

					TweenLite.to(this.messages_container, 3, {autoAlpha: 2});
					TweenLite.to(this.currentUserMessages, 3, {autoAlpha: 2});
				});
			}

			loadZiteIndicator() {
				var zite_indicator = document.getElementById('zite_num');
				//TweenLite.set(zite_indicator, {autoAlpha: 0});

				this.cmd("dbQuery", ["SELECT address FROM zites"], (zites) => {
					zite_indicator.innerHTML = zites.length + " zites";
					TweenLite.to(zite_indicator, 3, { autoAlpha: 2 });
				});

			}

			hideRemovalReasonTextbox() {
				document.getElementById('removal_reason').style.display = "none";
			}
			showRemovalReasonTextbox() {
				document.getElementById('removal_reason').style.display = "";
			}
		}

		page = new ZeroChat()

		function toggleRequestForm() {
			var form = document.getElementById('requestForm');
			var wasActive = hasClass(form, "is-active");
			toggleClass(form, "is-active");

			TweenLite.set(form, {
                autoAlpha: 0
            });
			if (wasActive == false) {
				TweenLite.to(form, 0.3, {
	                autoAlpha: 2
	            });
			}
		}
	</script>

	<!--<script>

	class Page extends ZeroFrame {
		setSiteInfo(site_info) {
			var out = document.getElementById("out")
			out.innerHTML =
				"Page address: " + site_info.address +
				"<br>- Peers: " + site_info.peers +
				"<br>- Size: " + site_info.settings.size +
				"<br>- Modified: " + (new Date(site_info.content.modified*1000))
		}

		onOpenWebsocket() {
			this.cmd("siteInfo", [], function(site_info) {
				page.setSiteInfo(site_info)
			})
		}

		onRequest(cmd, message) {
			if (cmd == "setSiteInfo")
				this.setSiteInfo(message.params)
			else
				this.log("Unknown incoming message:", cmd)
		}
	}
	page = new Page()

</script>-->

</body>
</html>